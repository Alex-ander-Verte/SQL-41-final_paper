SET search_path TO bookings;
--Задание 1
-- В каких городах больше одного аэропорта?

select distinct a.city --вывели уникальные названия городов
from airports a 
where a.city in (select a2.city --выбрали в подзапросе список городов
		from airports a2 -- из таблицы с аэропортами
		group by 1 --сгруппировали по городам
		having  count(*) > 1 --при условии, что количество аэропортов на каждый город больше 1
		)
order by a.city; --отсортировали по городу

--Задание 2
--В каких аэропортах есть рейсы, выполняемые самолетом с максимальной дальностью перелета? (Подзапрос)

select
	distinct on (a.airport_code) airport_code, --оставляем только уникальные коды аэропортов
	a.airport_name,
	t.aircraft_code --соотносим аэропорты и самолёт из подзапроса
from airports a
join flights f on --обогащаем данные таблией с рейсами, чтобы соединить таблицы по самолётам и аэропортам
	a.airport_code = f.departure_airport
	or a.airport_code = f.arrival_airport
join ( --обогащаем данными из подзапроса, в котором находим самолёт с максимальной дальностью перелёта
	select 	aircraft_code , "range"
	from aircrafts
	order by "range" desc --сортируем по дальности перелёта в порядке убывания
	limit 1 --ограничиваемся только 1 максимальным значением
	) t on 	f.aircraft_code = t.aircraft_code;

--Задание 3
--Вывести 10 рейсов с максимальным временем задержки вылета (Оператор LIMIT)

select actual_departure-scheduled_departure as departure_delay, * --выводим время задержки вылета и все данные по рейсам
from flights f 
where actual_departure-scheduled_departure is not null --при условии, что время задержки вылета имеет значение, т.е не пусто
order by actual_departure-scheduled_departure desc  --сортируем по убыванию согласно времени задержки вылета
limit 10; --ограничеваемся 10 записями

--Задание 4
--Были ли брони, по которым не были получены посадочные талоны? (Верный тип JOIN)

select b.book_ref, b.book_date, b.total_amount --выводим номера бронирований, без посадочных талонов
from boarding_passes bp 
right join ticket_flights tf on bp.ticket_no = tf.ticket_no and bp.flight_id = tf.flight_id --обогащаем данными из таблицы с перелётами, беря все значения из неё
right join tickets t on tf.ticket_no = t.ticket_no  --обогащаем данными из таблицы с билетами, беря все значения из неё
right join bookings b using (book_ref) --обогащаем данными из таблицы с бронированиями, беря все значения из неё
where bp.boarding_no is null; --берём только те значения, по которым отсутствуют посадочные талоны

--Задание 5
--Найдите количество свободных мест для каждого рейса, их % отношение к общему количеству мест в самолете.
--Добавьте столбец с накопительным итогом - суммарное накопление количества вывезенных пассажиров из каждого аэропорта на каждый день. 
--Т.е. в этом столбце должна отражаться накопительная сумма - сколько человек уже вылетело из данного аэропорта на этом или более ранних рейсах в течении дня.
--(Оконная функция, Подзапросы или/и cte)

--Задание 6
--Найдите процентное соотношение перелетов по типам самолетов от общего количества. (Подзапрос или окно, Оператор ROUND)

--Задание 7
--Были ли города, в которые можно  добраться бизнес - классом дешевле, чем эконом-классом в рамках перелета? (CTE)

--Задание 8
--Между какими городами нет прямых рейсов? (Декартово произведение в предложении FROM, Самостоятельно созданные представления
--(если облачное подключение, то без представления), Оператор EXCEPT)

--Задание 9
--Вычислите расстояние между аэропортами, связанными прямыми рейсами, сравните с допустимой максимальной дальностью перелетов  в самолетах, обслуживающих эти рейсы *
--(Оператор RADIANS или использование sind/cosd, CASE)

